#!/usr/bin/env node

/**
 * Removes files auto-generated by render-templates script (or at build-time).
 * Needs special files listing in `.gitignore`:
 * 
 * ```
 * # TEMPLATE TARGETS BEGIN
 * /docs/some/file1.md
 * /docs/some/file2.md
 * # TEMPLATE TARGETS END
 * ```
 * 
 * Requires Node v16+
 *
 * @author Jakub Liput
 * @copyright (C) 2024 ACK CYFRONET AGH
 * @license This software is released under the MIT license cited in 'LICENSE.txt'.
 */

const fs = require('fs');
const path = require('path');

const templateTargetsRe = /^# TEMPLATE TARGETS BEGIN\n((.|\n)*)\n# TEMPLATE TARGETS END/m;

const gitignoreContent = fs.readFileSync(
  path.resolve(__dirname, '.gitignore'),
  { encoding: 'utf-8'}
);

const templateTargetsContent = gitignoreContent.match(templateTargetsRe)[1];
const targets = templateTargetsContent.split('\n');

for (const target of targets) {
  console.log(`Deleting ${target}`);
  try {
    fs.rmSync(target);
  } catch (error) {
    // -2 is enoent - it is tolerated
    if (error.errno !== -2) {
      console.error(error);
    }
  }
}
